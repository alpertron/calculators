name: SonarCloud

on:
  push:
    branches:
      - master
  pull_request:

env:
  SONAR_HOST_URL: "https://sonarcloud.io"
  BUILD_WRAPPER_OUT_DIR: "bw-output"
  COVERAGE_FILE: "coverage.xml"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcovr

      # -------------------------------------------------------
      # Install Build Wrapper for Linux (SonarCFamily required)
      # -------------------------------------------------------
      - name: Download SonarCloud Build Wrapper
        run: |
          curl -sSLo build-wrapper-linux-x86-64.zip \
            "https://sonarcloud.io/static/cpp/build-wrapper-linux-x86-64.zip"

          unzip build-wrapper-linux-x86-64.zip
          ls -l build-wrapper-linux-x86-64

      # ----------------------------
      # Build using the build wrapper
      # ----------------------------
      - name: Build with Build Wrapper
        run: |
          ./build-wrapper-linux-x86-64/build-wrapper-linux-x86-64 \
            --out-dir $BUILD_WRAPPER_OUT_DIR \
            make clean all

      # ----------------------------
      # Generate Cobertura coverage
      # ----------------------------
      - name: Generate coverage report
        run: |
          gcovr -r . --cobertura-pretty --output $COVERAGE_FILE

      # -------------------------------------------
      # Install SonarScanner (not Java scanner 6.x!)
      # -------------------------------------------
      - name: Install SonarScanner CLI 5.x
        run: |
          curl -sSLo sonar-scanner.zip \
            "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip"

          unzip sonar-scanner.zip
          mv sonar-scanner-5.0.1.3006 sonar-scanner

      # -----------------------
      # SonarCloud C analysis
      # -----------------------
      - name: Run SonarScanner
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner/sonar-scanner \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.organization=alpertron \
            -Dsonar.projectKey=alpertron_calculators \
            -Dsonar.sources=. \
            -Dsonar.exclusions="**/*.md, **/docs/**, OldApplets/**" \
            -Dsonar.cfamily.build-wrapper-output=$BUILD_WRAPPER_OUT_DIR \
            -Dsonar.coverageReportPaths=$COVERAGE_FILE \
            -Dsonar.cfamily.cache.enabled=false \
            -Dsonar.token=$SONAR_TOKEN
