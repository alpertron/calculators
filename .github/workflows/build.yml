name: SonarCloud

on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: https://sonarcloud.io
      SONAR_SCANNER_VERSION: 6.0.0
      BUILD_WRAPPER_OUT_DIR: bw-out
      COVERAGE_FILE: coverage.xml

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcovr lcov curl unzip

      ###############################################################
      # 1) DOWNLOAD SONARCLOUD BUILD WRAPPER (CORRECT URL)
      ###############################################################
      - name: Download SonarCloud Build Wrapper
        run: |
          curl -sSLo build-wrapper-linux-x86.zip \
            "https://sonarcloud.io/static/cpp/build-wrapper-linux-x86.zip"

          unzip build-wrapper-linux-x86.zip
          ls -l build-wrapper-linux-x86

      ###############################################################
      # 2) COMPILE WITH BUILD WRAPPER
      ###############################################################
      - name: Build with Build Wrapper
        run: |
          ./build-wrapper-linux-x86/build-wrapper-linux-x86 \
            --out-dir $BUILD_WRAPPER_OUT_DIR \
            make clean all

      ###############################################################
      # 3) GENERATE COVERAGE â€” COMPATIBLE WITH SONAR (gcovr 1.x style)
      ###############################################################
      - name: Generate coverage report
        run: |
          gcovr \
            --xml-pretty \
            --output $COVERAGE_FILE \
            --gcov-ignore-errors=all \
            --exclude 'OldApplets/*' \
            --exclude 'docs/*' \
            --exclude 'sonar-scanner/*'

      ###############################################################
      # 4) INSTALL SONAR SCANNER
      ###############################################################
      - name: Install SonarScanner
        run: |
          curl -sSLo scanner.zip \
            "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux.zip"
          unzip scanner.zip -d .
          mv sonar-scanner-* sonar-scanner
          echo "${PWD}/sonar-scanner/bin" >> $GITHUB_PATH

      ###############################################################
      # 5) RUN SONAR SCANNER
      ###############################################################
      - name: Run SonarScanner
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.organization=alpertron \
            -Dsonar.projectKey=alpertron_calculators \
            -Dsonar.cfamily.build-wrapper-output=${BUILD_WRAPPER_OUT_DIR} \
            -Dsonar.coverageReportPaths=${COVERAGE_FILE} \
            -Dsonar.sources=. \
            -Dsonar.exclusions="**/*.md,**/docs/**,OldApplets/**,**/build-wrapper-dump.json" \
            -Dsonar.cfamily.cache.enabled=false
